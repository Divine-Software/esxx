PROJECT (esxx Java)
ENABLE_TESTING()

SET (CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules")

INCLUDE (DpkgDeb)
INCLUDE (Rpmbuild)

SET (PACKAGE_NAME ${PROJECT_NAME})
SET (PACKAGE_VERSION "20080419")
SET (PACKAGE_RELEASE 0)
SET (PACKAGE_MAINTAINER_NAME "Martin Blom")
SET (PACKAGE_MAINTAINER_EMAIL "martin@blom.org")
SET (PACKAGE_DESCRIPTION "ESXX - The friendly ECMAscript/XML Application ServerESXX")
SET (PACKAGE_DESCRIPTION_SUMMARY "ESXX")
SET (PACKAGE_DEPENDS ${esxx_dependencies})

IF (DPKG_FOUND)
  SET (PACKAGE_SECTION "checkinstall")
  SET (PACKAGE_PRIORITY "extra")
  ADD_DEBIAN_PACKAGE (${PROJECT_NAME})
  ADD_DEPENDENCIES(${PROJECT_NAME}_deb dist)
ENDIF (DPKG_FOUND)

IF (RPMBUILD_FOUND)
  SET (PACKAGE_GROUP "System Environment/Daemons")
  SET (PACKAGE_LICENSE "Proprietary")
  ADD_RPM (${PROJECT_NAME})
  ADD_DEPENDENCIES(${PROJECT_NAME}_rpm dist)
ENDIF (RPMBUILD_FOUND)

INCLUDE (Prefix)
FIND_PACKAGE (Java REQUIRED)
FIND_PROGRAM (ANT ant)

# Build using ANT
ADD_CUSTOM_TARGET(dist COMMAND 
		      ${ANT} -buildfile ${CMAKE_CURRENT_SOURCE_DIR}/build.xml 
		             -Dbuild.dir=${CMAKE_CURRENT_BINARY_DIR}/build
		             -Ddist.dir=${CMAKE_CURRENT_BINARY_DIR}/dist
			     clean dist)

FILE(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/dist/docs)

# Install init scripts
INSTALL (PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/package/@PROJECT_NAME@
		  ${CMAKE_CURRENT_BINARY_DIR}/package/@PROJECT_NAME@-binfmt
         DESTINATION ${SYSCONF_INSTALL_DIR}/init.d)

#INSTALL (PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/dist/esxx.jar
#         DESTINATION ${BIN_INSTALL_DIR})

INSTALL (PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/dist/esxx.jar 
         DESTINATION ${SBIN_INSTALL_DIR})

#INSTALL (DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/dist/docs
#	 DESTINATION ${SHARE_INSTALL_PREFIX}/doc/${PROJECT_NAME}/)

INSTALL (FILES ${CMAKE_CURRENT_BINARY_DIR}/dist/LICENSE.BSD
	       ${CMAKE_CURRENT_BINARY_DIR}/dist/LICENSE.GPL-2
	       ${CMAKE_CURRENT_BINARY_DIR}/dist/LICENSE.HtmlCleaner
	       ${CMAKE_CURRENT_BINARY_DIR}/dist/LICENSE.JavaMail
	       ${CMAKE_CURRENT_BINARY_DIR}/dist/README
	 DESTINATION ${SHARE_INSTALL_PREFIX}/doc/${PROJECT_NAME}/)

# Create init scripts and shell wrappers
CONFIGURE_FILE(package/initscript-esxx.in 
               ${CMAKE_CURRENT_BINARY_DIR}/package/@PROJECT_NAME@ @ONLY)
CONFIGURE_FILE(package/initscript-binfmt.in 
               ${CMAKE_CURRENT_BINARY_DIR}/package/@PROJECT_NAME@-binfmt @ONLY)
CONFIGURE_FILE(package/javawrapper.in ${CMAKE_CURRENT_BINARY_DIR}/@PROJECT_NAME@ @ONLY)
INSTALL (PROGRAMS ${CMAKE_CURRENT_BINARY_DIR}/${PROJECT_NAME}
         DESTINATION ${SBIN_INSTALL_DIR})
